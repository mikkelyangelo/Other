CREATE DEFINER=`root`@`localhost` PROCEDURE `otchet`(year_d INT, month_d INT)
BEGIN
	DECLARE nums DATE;
	DECLARE Fcs varchar(50);
	DECLARE qt int;
    DECLARE done INT DEFAULT 0;
    
    
	DECLARE c1 cursor for
		SELECT distinct DATA,HALL_NAME,sum(price)
		FROM ticket JOIN session
        ON SESSION_ID = S_ID
        JOIN hall 
        ON HALL = HALL_ID
        where year(DATA) = year_d AND month(DATA) = month_d
        GROUP BY S_ID;
        
	Declare continue HANDLER for SQLSTATE '02000' set done = 1;

		Open c1;        
		While done = 0 do
        
			fetch c1 into nums, Fcs, qt;
			IF nums is not null THEN
				INSERT report(years, months, date_s,h_name,sum_t)
						values(year_d, month_d, nums, Fcs, qt);
			ELSE 
				SELECT nums;
			END IF;
		END WHILE;
		CLOSE c1;
END